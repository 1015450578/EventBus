# 搜道RabbitMQ事件总线

## 该项目属于基础设施

为搜道项目提供事件总线的SDK。

**注意该项目的 IDE 需求**：Visual Studio 2015 R3 或更高。

**合并请求的注意事项**：该项目接受来自所有小组的请求，尽可能的不要请求合并master分支，而是用于开发的dev分支。

>重要提示: 该基础设施的当前状态仍处于迭代更新的阶段，同时项目正在不断向新发布的技术演进，因此，在重构当前代码和实现新特性的同时，许多领域可以得到改进和显着改变。反馈与社区的改进和pull请求将会绝对的被接受。
>
>该基础设施应用了面向模块化的架构，通过一个具体的功能业务来引入诸如 模块化 的技术。之所以选择面向模块化，仅仅是因为它是大多数人/开发人员以及面向对象语言的优势。

## 发送反馈和拉取请求

综上所述，非常感谢各个小组成员的反馈、改进和想法，您可以在问题部分创建新问题，请求和/或发送电子邮件到架构组的任何成员

## 架构概述

每个微服务类型应该是对应一个名称的默认队列，而不是每个微服务实例对应一个名称的默认队列。因为每个实例采用一个自己名称的默认队列，导致队列名过多，且极容易出现重复处理同一个事件。

>为什么队列过多？
>
>因为实例级别的队列名，通常只能采用随机的名称，也就是说，服务的重启，都会创建一个随机名称的队列，而EventBus的队列都采用了持久化而非临时化的队列声明方式。

.

>为什么不能使用临时化的队列声明方式？
>
>当事件过多，消息往往不能立即被消费，此时消息已经被转发到当前的队列中，并被堆积。如果此时微服务出现了宕机事故，消息队列也会随之删除，会导致数据的意外丢失。

每个 `EventBus` 对象对于每个应用程序内部是单例的，但所有应用程序的 `EventBus` 均访问的是同一个交换机 `sodao_shop_event_bus`.

每个事件都对应了一个 RoutingKey.

当 `EventBus` 对象第一次初始化时，会尝试连接 RabbitMQ ，并创建一个`默认的队列`。`默认队列`名通过 `RabbitMQEventBusOptions` 类型的 `QueueName` 属性进行指定，此时`默认队列`不会和交换机绑定，也就是说，发布的任何事件，均无法转发到该队列。

当 `EventBus` 创建完成后，通过 `Subscribe` 方法订阅指定的事件，此时`默认队列`，会要求交换机将制定 RoutingKey 的消息转发到当前的队列中。一个事件可以拥有多个处理程序。

当调用 `Unsubscribe` 方法时，会移除事件处理程序，当一个事件没有事件处理程序时，交换机将不会转发事件消息到`默认队列`。